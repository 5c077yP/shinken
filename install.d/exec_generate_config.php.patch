*** exec_generate_config.php.original   2012-08-12 16:23:31.171004520 +0200
--- exec_generate_config.php    2012-08-12 16:47:40.999271280 +0200
***************
*** 52,66 ****
  
      // check if the Nagios / Icinga binary is executable
      exec(NAGIOS_BIN,$bin_out);
!     if(!preg_match('/Nagios|Icinga/',implode(' ',$bin_out))){
!         $content = "Error accessing or executing Nagios / Icinga binary '".NAGIOS_BIN."'. <br>Cannot run the mandatory syntax check.";
          NConf_DEBUG::set($content, 'ERROR');
          echo NConf_HTML::limit_space(
              NConf_HTML::show_error('Error')
          );
          remove_lock();
          exit;
!   }
  
      // check if existing "output/NagiosConfig.tgz" is writable
      if(file_exists(NCONFDIR."/output/NagiosConfig.tgz" and !is_writable(NCONFDIR."/output/NagiosConfig.tgz"))){
--- 52,74 ----
  
      // check if the Nagios / Icinga binary is executable
      exec(NAGIOS_BIN,$bin_out);
!     $engine = "nagios";
!     if(!preg_match('/Nagios|Icinga|Shinken/',implode(' ',$bin_out))){
! 
!         $content = "Error accessing or executing Nagios / Icinga / Shinken binary '".NAGIOS_BIN."'. <br>Cannot run the mandatory syntax check.";
          NConf_DEBUG::set($content, 'ERROR');
          echo NConf_HTML::limit_space(
              NConf_HTML::show_error('Error')
          );
          remove_lock();
          exit;
!   }else{
!     if (preg_match('/Shinken/',implode(' ',$bin_out))){
!             $engine = "shinken";
!         }else{
!             $engine = "nagios";
!         }
!     }
  
      // check if existing "output/NagiosConfig.tgz" is writable
      if(file_exists(NCONFDIR."/output/NagiosConfig.tgz" and !is_writable(NCONFDIR."/output/NagiosConfig.tgz"))){
***************
*** 103,109 ****
          $renamed = preg_replace('/-|\s/','_',$entry["attr_value"]);
  
          if($entry["config_class"] == 'nagios-collector'){
!             $renamed = preg_replace('/Nagios|Icinga/i','collector',$renamed);
          }
          array_push($servers, $renamed);
      }
--- 111,117 ----
          $renamed = preg_replace('/-|\s/','_',$entry["attr_value"]);
  
          if($entry["config_class"] == 'nagios-collector'){
!             $renamed = preg_replace('/Nagios|Icinga|Shinken/i','collector',$renamed);
          }
          array_push($servers, $renamed);
      }
***************
*** 175,190 ****
  
          $total_msg = '';
          $count=0;
          $i = 0;
          foreach($srv_summary[$server] as $line){
!             if( preg_match("/^Total/",$line) ){
!                 # add splitter between messages
                  $total_msg .= ( $i > 0 ) ? $break : '';
                  $i++;
                  $total_msg .= $line;
                  $count++;
!                 if( preg_match("/Errors/",$line) && !preg_match('/Total Errors:\s+0/',$line)){
!                     $status = "error";
                  }
              }
          }
--- 183,219 ----
  
          $total_msg = '';
          $count=0;
+   $error_count=0;
+   $warning_count=0;
          $i = 0;
          foreach($srv_summary[$server] as $line){
!             if ($engine == "shinken"){
                  $total_msg .= ( $i > 0 ) ? $break : '';
                  $i++;
                  $total_msg .= $line;
                  $count++;
!                 if( preg_match("/Error/",$line)){
!                         $status = "error";
!           $error_count++;
!                 }
!       if( preg_match("/Warning/",$line)){
!                         $warning_count++;
!                 }
! 
!             }else{
!                 if( preg_match("/^Total/",$line) ){
!                     # add splitter between messages
!                     $total_msg .= ( $i > 0 ) ? $break : '';
!                     $i++;
!                     $total_msg .= $line;
!                     $count++;
!                     if( preg_match("/Errors/",$line) && !preg_match('/Total Errors:\s+0/',$line)){
!                         $status = "error";
!           $error_count++;
!                     }
!           if( preg_match("/Warning/",$line)){
!                         $warning_count++;
!                     }
                  }
              }
          }
***************
*** 196,204 ****
  
          $total_msg = '<span class="notBold accordion_header_right">'.$total_msg.'</span>';
          // print server info
!         $title = '<span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">'.$server_str.$total_msg.'</a>';
          echo NConf_HTML::title($title, 3, 'class="accordion_title ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom"');
          echo '<div class="accordion_content ui-widget-content ui-corner-bottom monospace" style="display: none;">';
              foreach($srv_summary[$server] as $line){
                  if ( preg_match("/^Error:/",$line) ){
                      echo '<span class="red">'.$line.'</span>';
--- 225,252 ----
  
          $total_msg = '<span class="notBold accordion_header_right">'.$total_msg.'</span>';
          // print server info
!         #$title = '<span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">'.$server_str.$total_msg.'</a>';
!         #$title = '<span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">'."Errors: ".$error_count." Warning: ".$warning_count.'</a>';
!         $title = '<span class="ui-icon ui-icon-triangle-1-e"></span><a href="#">'.'<span class="red">Errors: '.$error_count.'</span><span class="orange"> &emsp;Warning: '.$warning_count.'</span></a>';
          echo NConf_HTML::title($title, 3, 'class="accordion_title ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom"');
          echo '<div class="accordion_content ui-widget-content ui-corner-bottom monospace" style="display: none;">';
+ 
+   if ($engine == "shinken"){
+             foreach($srv_summary[$server] as $line){
+                 if ( preg_match("/Error:/",$line) ){
+                     echo '<span class="red">'.$line.'</span>';
+                 }elseif ( preg_match("/Warning:/",$line) ){
+                     echo '<span class="orange">'.$line.'</span>';
+                 }else{
+                     echo $line;
+                 }
+                 echo '<br>';
+             }
+             echo '<br>';
+         echo '</div>';
+ 
+   }else{
+ 
              foreach($srv_summary[$server] as $line){
                  if ( preg_match("/^Error:/",$line) ){
                      echo '<span class="red">'.$line.'</span>';
***************
*** 211,216 ****
--- 259,267 ----
              }
              echo '<br>';
          echo '</div>';
+ 
+   }
+ 
          
      }
  
***************
*** 271,277 ****
          }
          // Remove generated config
          system("rm -rf ".NCONFDIR."/temp/*");
!         $content = "Deployment not possible due to errors in configuration.";
          echo NConf_HTML::limit_space(
              NConf_HTML::show_error('Error', $content)
          );
--- 322,328 ----
          }
          // Remove generated config
          system("rm -rf ".NCONFDIR."/temp/*");
!         $content = "Deployment not possible due to errors in configuration. (".$engine.")";
          echo NConf_HTML::limit_space(
              NConf_HTML::show_error('Error', $content)
          );